<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Blast 9x9 Master</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="best-score-box">
                <span class="crown-icon">üëë</span>
                <div class="score-text">
                    <span class="label-tiny">Best</span>
                    <span id="best-score">0</span>
                </div>
            </div>
            <div class="header-buttons">
                <button class="btn-icon" onclick="toggleSettings()">‚öôÔ∏è</button>
                <button class="btn-rank" onclick="toggleLeaderboard()">üèÜ TOP</button>
            </div>
        </div>
        <div class="current-score-display">
            <div id="score">0</div>
        </div>
        <div class="game-area">
            <div id="game-board" class="board"></div>
        </div>
        <div id="shapes-container" class="shapes-area"></div>
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content settings-panel">
                <div class="settings-header">
                    <h3>C√†i ƒê·∫∑t</h3>
                    <span class="close-btn" onclick="toggleSettings()">‚úñ</span>
                </div>
                <div class="setting-row">
                    <span>üì≥ Rung (Vibration)</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-vibration" onchange="updateSetting('vibration')">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="setting-actions">
                    <button class="btn-setting btn-green" onclick="location.reload()">üîÑ Ch∆°i L·∫°i</button>
                    <button class="btn-setting btn-blue" onclick="toggleSettings()">‚ñ∂ Ti·∫øp T·ª•c</button>
                </div>
            </div>
        </div>
        <div id="game-over-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="go-title">GAME OVER!</h2>
                <p>ƒêi·ªÉm c·ªßa b·∫°n: <span id="final-score" style="color: #e74c3c; font-weight: bold;">0</span></p>
                <div class="input-group">
                    <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="15">
                </div>
                <div class="btn-group">
                    <button class="btn-save" onclick="saveHighScore()">L∆∞u ƒêi·ªÉm & Ch∆°i L·∫°i</button>
                    <button class="btn-replay" onclick="location.reload()">Th·ª≠ L·∫°i Ngay</button>
                </div>
            </div>
        </div>
        <div id="leaderboard-modal" class="modal hidden">
            <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
                <h3>üèÜ B·∫£ng X·∫øp H·∫°ng</h3>
                <ul id="leaderboard-list">ƒêang t·∫£i d·ªØ li·ªáu...</ul>
                <button class="btn-close" onclick="toggleLeaderboard()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyDPxX0aiLsZrmQ27ol_tfwMSHthXsXa2w8",
            authDomain: "huy-block.firebaseapp.com",
            projectId: "huy-block",
            storageBucket: "huy-block.firebasestorage.app",
            messagingSenderId: "1081224684854",
            appId: "1:1081224684854:web:8a778b900f47011d6d3f97",
            measurementId: "G-XC40RP34PG"
        };
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase ƒë√£ k·∫øt n·ªëi!");
        } catch (e) {
            console.error("L·ªói k·∫øt n·ªëi Firebase:", e);
        }
        window.saveHighScore = async () => {
            const name = document.getElementById('player-name').value.trim();
            const score = parseInt(document.getElementById('final-score').innerText);
            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");
            if (db) {
                try {
                    await addDoc(collection(db, "leaderboard_9x9"), {
                        name: name,
                        score: score,
                        createdAt: new Date()
                    });
                    alert("ƒê√£ l∆∞u ƒëi·ªÉm th√†nh c√¥ng!");
                    location.reload();
                } catch (error) {
                    console.error("Chi ti·∫øt l·ªói:", error);
                    alert("L·ªói: " + error.message + "\n(H√£y ki·ªÉm tra tab Firestore Database ƒë√£ b·∫≠t Test Mode ch∆∞a)");
                }
            } else {
                alert("Kh√¥ng c√≥ k·∫øt n·ªëi Database! (Ch∆°i Offline)");
                location.reload();
            }
        };
        window.toggleLeaderboard = () => {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden') && db) {
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = "<li>ƒêang t·∫£i...</li>";
                try {
                    const q = query(collection(db, "leaderboard_9x9"), orderBy("score", "desc"), limit(20));
                    onSnapshot(q, (snapshot) => {
                        list.innerHTML = "";
                        let rank = 1;
                        if(snapshot.empty) {
                             list.innerHTML = "<li>Ch∆∞a c√≥ ai ƒëua top. B·∫°n h√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</li>";
                             return;
                        }
                        snapshot.forEach((doc) => {
                            const d = doc.data();
                            let color = rank === 1 ? '#f1c40f' : rank === 2 ? '#bdc3c7' : rank === 3 ? '#cd7f32' : '#fff';
                            let icon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                            list.innerHTML += `
                                <li style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #444; color: ${color}; align-items: center;">
                                    <span style="font-weight: bold;">${icon} ${d.name}</span>
                                    <span style="font-family: monospace; font-size: 1.2em;">${d.score}</span>
                                </li>`;
                            rank++;
                        });
                    }, (error) => {
                        console.error(error);
                        list.innerHTML = "<li>L·ªói quy·ªÅn truy c·∫≠p (Permission Denied). H√£y b·∫≠t Test Mode trong Firestore.</li>";
                    });
                } catch (err) {
                    list.innerHTML = "<li>L·ªói k·∫øt n·ªëi.</li>";
                }
            }
        };
    </script>

    <script src="game.js"></script>
</body>
</html>
