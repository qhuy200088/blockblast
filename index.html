<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Blast 9x9 Master</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="best-score-box">
                <span class="crown-icon">üëë</span>
                <div class="score-text">
                    <span class="label-tiny">Best</span>
                    <span id="best-score">0</span>
                </div>
            </div>
            <div class="header-buttons">
                <button class="btn-icon" onclick="toggleSettings()">‚öôÔ∏è</button>
                <button class="btn-rank" onclick="toggleLeaderboard()">üèÜ TOP</button>
            </div>
        </div>
        <div class="current-score-display">
            <div id="score">0</div>
        </div>
        <div class="game-area">
            <div id="game-board" class="board"></div>
        </div>
        <div id="shapes-container" class="shapes-area"></div>
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content settings-panel">
                <div class="settings-header">
                    <h3>C√†i ƒê·∫∑t</h3>
                    <span class="close-btn" onclick="toggleSettings()">‚úñ</span>
                </div>
                <div class="setting-row">
                    <span>üì≥ Rung (Vibration)</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-vibration" onchange="updateSetting('vibration')">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="setting-actions">
                    <button class="btn-setting btn-green" onclick="location.reload()">üîÑ Ch∆°i L·∫°i</button>
                    <button class="btn-setting btn-blue" onclick="toggleSettings()">‚ñ∂ Ti·∫øp T·ª•c</button>
                </div>
            </div>
        </div>
        <div id="game-over-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="go-title">GAME OVER!</h2>
                <p>ƒêi·ªÉm c·ªßa b·∫°n: <span id="final-score" style="color: #e74c3c; font-weight: bold;">0</span></p>
                <div class="btn-group">
                    <button class="btn-save" onclick="saveHighScore()">L∆∞u K·ª∑ L·ª•c</button>
                    <button class="btn-replay" onclick="location.reload()">Ch∆°i L·∫°i</button>
                </div>
            </div>
        </div>
        <div id="leaderboard-modal" class="modal hidden">
            <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
                <h3>üèÜ B·∫£ng X·∫øp H·∫°ng</h3>
                <ul id="leaderboard-list">ƒêang t·∫£i d·ªØ li·ªáu...</ul>
                <button class="btn-close" onclick="toggleLeaderboard()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, orderBy, limit, onSnapshot } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyDPxX0aiLsZrmQ27ol_tfwMSHthXsXa2w8",
            authDomain: "huy-block.firebaseapp.com",
            projectId: "huy-block",
            storageBucket: "huy-block.firebasestorage.app",
            messagingSenderId: "1081224684854",
            appId: "1:1081224684854:web:8a778b900f47011d6d3f97",
            measurementId: "G-XC40RP34PG"
        };
        let db;
        let currentUserId = localStorage.getItem('device_user_id'); 
        let currentUserName = localStorage.getItem('device_user_name');
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            checkUserIdentity(); 
        } catch (e) {
            console.error("L·ªói k·∫øt n·ªëi Firebase:", e);
        }
        function checkUserIdentity() {
            if (!currentUserId) {
                currentUserId = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
                localStorage.setItem('device_user_id', currentUserId);
            }
            if (!currentUserName) {
                setTimeout(() => {
                    let nameInput = prompt("Ch√†o b·∫°n m·ªõi! H√£y ƒë·∫∑t t√™n hi·ªÉn th·ªã tr√™n B·∫£ng X·∫øp H·∫°ng:", "GameThu_VN");
                    if (!nameInput || nameInput.trim() === "") nameInput = "Khach_" + Math.floor(Math.random()*100);
                    currentUserName = nameInput;
                    localStorage.setItem('device_user_name', currentUserName);
                    alert(`ƒê√£ l∆∞u! T√™n c·ªßa b·∫°n l√†: ${currentUserName}`);
                }, 800);
            }
        }
        window.saveHighScore = async () => {
            const score = parseInt(document.getElementById('final-score').innerText);
            if (!db) return alert("M·∫•t k·∫øt n·ªëi Server (Offline)");
            try {
                const userRef = doc(db, "leaderboard_9x9", currentUserId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const oldData = userSnap.data();
                    if (score > oldData.score) {
                        await setDoc(userRef, {
                            name: currentUserName, 
                            score: score,
                            updatedAt: new Date()
                        });
                        alert(`Tuy·ªát v·ªùi! K·ª∑ l·ª•c m·ªõi: ${score} ƒëi·ªÉm ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`);
                    } else {
                        alert(`ƒêi·ªÉm hi·ªán t·∫°i (${score}) th·∫•p h∆°n k·ª∑ l·ª•c c≈© (${oldData.score}). Kh√¥ng c·∫≠p nh·∫≠t.`);
                    }
                } else {
                    await setDoc(userRef, {
                        name: currentUserName,
                        score: score,
                        createdAt: new Date()
                    });
                    alert("ƒê√£ ghi danh v√†o B·∫£ng X·∫øp H·∫°ng l·∫ßn ƒë·∫ßu!");
                }
                location.reload();
            } catch (error) {
                console.error("L·ªói:", error);
                alert("L·ªói khi l∆∞u ƒëi·ªÉm. (Check Console)");
            }
        };
        window.toggleLeaderboard = () => {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden') && db) {
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = "<li>ƒêang t·∫£i...</li>";
                const q = query(collection(db, "leaderboard_9x9"), orderBy("score", "desc"), limit(20));
                onSnapshot(q, (snapshot) => {
                    list.innerHTML = "";
                    let rank = 1;
                    if(snapshot.empty) { list.innerHTML = "<li>Ch∆∞a c√≥ d·ªØ li·ªáu</li>"; return; }
                    snapshot.forEach((docSnap) => {
                        const d = docSnap.data();
                        const isMe = docSnap.id === currentUserId;
                        let color = rank === 1 ? '#f1c40f' : rank === 2 ? '#bdc3c7' : rank === 3 ? '#cd7f32' : '#fff';
                        let style = isMe ? 'background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71;' : '';
                        let icon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                        list.innerHTML += `
                            <li style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #444; color: ${color}; align-items: center; ${style}">
                                <span style="font-weight: bold;">${icon} ${d.name} ${isMe ? '(B·∫°n)' : ''}</span>
                                <span style="font-family: monospace; font-size: 1.2em;">${d.score}</span>
                            </li>`;
                        rank++;
                    });
                });
            }
        };
    </script>

    <script src="game.js"></script>
</body>
</html>
