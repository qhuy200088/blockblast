<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- C·∫§U H√åNH C·ª¶A B·∫†N (ƒê√£ ƒëi·ªÅn s·∫µn) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPxX0aiLsZrmQ27ol_tfwMSHthXsXa2w8",
            authDomain: "huy-block.firebaseapp.com",
            projectId: "huy-block",
            storageBucket: "huy-block.firebasestorage.app",
            messagingSenderId: "1081224684854",
            appId: "1:1081224684854:web:8a778b900f47011d6d3f97",
            measurementId: "G-XC40RP34PG"
        };

        // Kh·ªüi t·∫°o Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("K·∫øt n·ªëi Firebase th√†nh c√¥ng!");
        } catch (e) {
            console.error("L·ªói k·∫øt n·ªëi Firebase:", e);
            alert("L·ªói k·∫øt n·ªëi Server: " + e.message);
        }

        // 1. H√†m l∆∞u ƒëi·ªÉm
        window.saveHighScore = async () => {
            const name = document.getElementById('player-name').value.trim();
            const score = parseInt(document.getElementById('final-score').innerText);
            
            if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");
            
            if (db) {
                try {
                    // Th√™m d·ªØ li·ªáu v√†o collection "leaderboard_9x9"
                    await addDoc(collection(db, "leaderboard_9x9"), {
                        name: name,
                        score: score,
                        createdAt: new Date()
                    });
                    alert("ƒê√£ l∆∞u ƒëi·ªÉm l√™n Server th√†nh c√¥ng!");
                    location.reload();
                } catch (error) {
                    console.error("Chi ti·∫øt l·ªói:", error);
                    alert("L·ªói khi l∆∞u ƒëi·ªÉm. H√£y ki·ªÉm tra l·∫°i tab Firestore Database ƒë√£ chuy·ªÉn sang 'Test Mode' ch∆∞a.");
                }
            } else {
                alert("Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c Database!");
            }
        };

        // 2. H√†m t·∫£i BXH
        window.toggleLeaderboard = () => {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.toggle('hidden');
            
            if (!modal.classList.contains('hidden') && db) {
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = "<li>ƒêang t·∫£i d·ªØ li·ªáu...</li>";

                // L·∫•y 20 ng∆∞·ªùi ƒëi·ªÉm cao nh·∫•t
                const q = query(collection(db, "leaderboard_9x9"), orderBy("score", "desc"), limit(20));
                
                onSnapshot(q, (snapshot) => {
                    list.innerHTML = "";
                    let rank = 1;
                    if (snapshot.empty) {
                        list.innerHTML = "<li>Ch∆∞a c√≥ d·ªØ li·ªáu n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</li>";
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const d = doc.data();
                        let color = rank === 1 ? '#f1c40f' : rank === 2 ? '#bdc3c7' : rank === 3 ? '#cd7f32' : '#fff';
                        // Icon top 3
                        let icon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                        
                        list.innerHTML += `
                            <li style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #444; color: ${color}; align-items: center;">
                                <span style="font-weight: bold;">${icon} ${d.name}</span>
                                <span style="font-family: monospace; font-size: 1.1em;">${d.score}</span>
                            </li>`;
                        rank++;
                    });
                }, (error) => {
                    console.error("L·ªói t·∫£i BXH:", error);
                    list.innerHTML = "<li>L·ªói t·∫£i d·ªØ li·ªáu (Xem Console)</li>";
                });
            }
        };
    </script>
